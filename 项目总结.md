# 电缆长度测量仪项目总结

## 1. 项目概述

本项目旨在通过FPGA实现一个电缆长度测量仪。该仪器通过测量待测电缆的谐振频率，利用线性插值算法计算出电缆的物理长度，并将最终结果（单位：厘米）显示在7段数码管上。

## 2. 实现原理

项目的核心物理原理是电缆的长度与其谐振频率（或周期）之间存在确定的、近似线性的关系。硬件实现流程如下：

1.  **周期测量**: `period_measure.v` 模块负责精确测量外部输入信号 `SIG_FX` 的周期。它通过一个计数器，计算出信号的10个完整周期内包含了多少个系统主时钟（12MHz）周期，从而得到一个高精度的周期计数值。
2.  **数字滤波**: `digital_filter.v` 模块对周期测量模块输出的原始数据进行移动平均滤波。它累加16个连续的测量样本并计算其平均值，以消除信号抖动带来的误差，输出一个稳定、可靠的周期计数值 `N`。
3.  **状态控制与计算**: `main_fsm.v` 是整个系统的控制核心。它根据模式开关的状态，调度不同的工作模式，并执行核心的插值计算，最终将待显示的数据发送给显示驱动模块。

## 3. 核心算法

系统采用**查表法**与**线性插值**相结合的算法来计算电缆长度。为了简化设计并保证精度，我们放弃了自校准方案，转而采用固化标准值的方式。

1.  **固化校准数据**: 系统内置了4个标准长度（0m, 10m, 15m, 20m）及其对应的、预先测得的周期计数值 `N`。这些数据作为插值计算的基准点。

2.  **线性插值**: 当测得一个待测电缆的周期计数值 `N_O_reg` 后，系统首先通过比较，确定 `N_O_reg` 落在哪个校准区间 `[N_i, N_{i+1}]` 内。然后，使用以下线性插值公式计算长度：

    `L_O = L_i + (N_O_reg - N_i) * (L_{i+1} - L_i) / (N_{i+1} - N_i)`

3.  **定点数乘法优化**: 为了避免在FPGA上实现复杂且消耗资源的除法器，我们将上述公式中的除法 `product / delta_N` 替换为**乘法和移位**操作。
    *   **原理**: `product / delta_N` 等效于 `product * (1 / delta_N)`。
    *   **实现**: 我们预先计算出每个插值区间的 `delta_N` 的倒数，并将其乘以 `2^24` 放大为一个高精度的定点数（整数）并存入代码中。
    *   **最终计算**: `quotient = (product * RECIP_N) >> 24`。这样，原本需要16个时钟周期的除法运算，被一个3周期的乘法-移位流水线所取代，既解决了潜在的逻辑问题，又提升了运算效率。

## 4. 模块功能

-   `top_module.v`: 顶层模块，例化并连接了系统中的所有子模块。
-   `main_fsm.v`: **核心控制模块**。
    -   实现了一个多状态的状态机，管理系统的工作模式。
    -   内置校准数据显示功能。
    -   实现了基于定点数优化的线性插值算法流水线。
-   `period_measure.v`: 输入信号周期测量模块。
-   `digital_filter.v`: 周期数据数字滤波器，采用移动平均法。
-   `display_driver.v`: 4位7段数码管的扫描驱动及译码模块。
-   `debounce.v`: 按键消抖模块（在最终设计中其触发功能被自动测量取代）。

## 5. 操作说明

通过板上的两位模式开关 `MODE_SW` 来选择不同的工作模式：

-   **`2'b00` (空闲模式)**: 默认状态。数码管滚动显示学号。
-   **`2'b01` (校准数据显示模式)**: 系统会自动循环显示内部存储的4组标准长度 `L` (单位cm) 和对应的周期计数值 `N`，每个值停留约1.5秒，用于验证校准数据。
-   **`2'b10` (自动测量模式)**: **核心功能**。当开关拨到此模式时，系统会自动进行一次电缆长度测量，计算完成后，数码管将持续显示最终测得的电缆长度，单位为**厘米(cm)**。如需重新测量，将开关拨离此模式再拨回即可。
-   **`2'b11` (诊断模式)**: 在当前版本中，此模式被保留，用于未来可能的调试需求。

## 6. 最终成果

本项目成功实现了一个功能稳定、操作简便的电缆长度测量仪。最终版本采用自动触发测量，并通过优化的定点数算法保证了计算的准确性和硬件效率，达到了预期的设计目标。
